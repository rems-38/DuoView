<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoView</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1 class="title">DuoView</h1>

    <div id="loading" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <video id="video" controls preload="auto" class="bg-video">
        <source src="/video" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="chat-container">
        <h2>Chat</h2>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" class="form-control" placeholder="Entrez votre message...">
            <button id="send-button" class="btn btn-primary">Envoyer</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const loading = document.getElementById('loading');              
        const ws = new WebSocket(`ws://${window.location.host}`);

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            checkBuffering();
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.event === 'sync') {
                console.log('Received sync event:', data);

                const offset = document.getElementsByName('time')[0].value;
                if (offset) {
                    video.currentTime = data.currentTime - offset;
                } else { video.currentTime = data.currentTime; }
            }

            if (data.event === 'play') {
                console.log('Received play event');
                video.play();
            }

            if (data.event === 'pause') {
                console.log('Received pause event');
                video.pause();
            }

            if (data.event === 'time') {
                console.log('Received time event:', data);

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'time';
                input.value = data.currentTime;
                document.body.appendChild(input);
            }
        };

        video.addEventListener('play', () => {
            event.preventDefault();
            console.log('Sending play event')
            ws.send(JSON.stringify({ event: 'play' }));
        });

        video.addEventListener('pause', () => {
            event.preventDefault();
            console.log('Sending pause event')
            ws.send(JSON.stringify({ event: 'pause' }));
        });

        function checkBuffering() {
            const buffered = video.buffered;
            if (buffered.length > 0) {
                const bufferEnd = buffered.end(0);
                const bufferStart = buffered.start(0);
                const bufferDuration = bufferEnd - bufferStart;
                console.log(`Buffer duration is ${bufferDuration} seconds`);

                if (bufferDuration > 10) {
                    isReady = true;
                    loading.style.display = 'none';
                    video.style.display = 'block';
                } else {
                    loading.style.display = 'block';
                    video.style.display = 'none';
                    setTimeout(checkBuffering, 1000);
                }
            } else {
                loading.style.display = 'block';
                video.style.display = 'none';
                setTimeout(checkBuffering, 1000);
            }
        }
    </script>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const socket = io();
        let username = '';

        $(document).ready(() => {
            username = prompt('Enter your username :');
            socket.emit('user-connected', username);

            function sendMessage() {
                const message = $('#chat-input').val();
                if (message.trim() !== '') {
                    socket.emit('chat-message', {username, message});
                    $('#chat-input').val('');
                }
            }

            $('#send-button').click(() => {
                sendMessage();
            });
            
            $('#chat-input').keydown((event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // EmpÃªche l'ajout d'une nouvelle ligne dans le champ texte
                    sendMessage();
                }
            });

            socket.on('chat-message', (data) => {
                $('#chat-messages').append(`<div><strong>${data.username}</strong> : ${data.message} <small class="text-muted">${data.time}</small></div>`);
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            });

            socket.on('system-message', (message) => {
                $('#chat-messages').append(`<div class="system-message">${message}</div>`);
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            });
        });
    </script>
</body>
</html>
